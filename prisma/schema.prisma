// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  
  // Mandatory Fields (Green in image)
  title          String?   // Mr, Mrs, Ms, Dr, Other
  firstName      String
  middleName     String?
  lastName       String
  dateOfBirth    DateTime
  gender         String   // Male/Female/Other
  completeAddress String  // House/Apt, Street
  city           String
  state          String
  zipcode        String
  primaryEmail   String   @unique
  alternativeEmail String?
  primaryPhone   String
  alternativePhone String?
  emergencyContactName String
  emergencyContactRelationship String?
  emergencyContactPhone String
  referringSource String // Online/Friend/Employee
  consentForTreatment String // Y/N
  hipaaPrivacyNoticeAcknowledgment String // Y/N
  releaseOfMedicalRecordsConsent String // Y/N
  preferredMethodOfCommunication String // Phone/Email/Mail
  disabilityAccessibilityNeeds String?
  
  // Optional Fields (Yellow in image)
  careProviderPhone String?
  lastFourDigitsSSN String?
  languagePreference String?
  ethnicityRace String?
  primaryCarePhysician String?
  insuranceProviderName String?
  insurancePolicyNumber String?
  insuranceGroupNumber String?
  insurancePhoneNumber String?
  guarantorResponsibleParty String?
  dateOfRegistration DateTime @default(now())
  dateOfFirstVisitPlanned DateTime?
  interpreterRequired String? // Y/N
  advanceDirectives String? // Y/N
  
  // Legacy fields (keeping for backward compatibility)
  email     String   @unique // maps to primaryEmail
  password  String
  phone     String?  // maps to primaryPhone
  isActive  Boolean  @default(true)
  
  // Email verification fields
  isEmailVerified           Boolean  @default(false)
  emailVerificationToken    String?
  emailVerificationTokenExpiry DateTime?
  
  // Password reset fields
  resetToken        String?
  resetTokenExpiry  DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Medical form completion tracking
  hasCompletedMedicalForm Boolean @default(false)
  medicalFormCompletedAt DateTime?
  
  // Intake form completion tracking (for first-time users)
  hasCompletedIntakeForm Boolean @default(false)
  intakeFormCompletedAt DateTime?

  // Relations
  bookings Booking[]
  patientAppointments Appointment[]
  medicalForms MedicalForm[]

  @@map("users")
}

// Doctor model for healthcare providers
model Doctor {
  id                String   @id @default(uuid())
  
  // Authentication fields
  email             String   @unique
  password          String
  isActive          Boolean  @default(true)
  
  // Email verification fields
  isEmailVerified           Boolean  @default(false)
  emailVerificationToken    String?
  emailVerificationTokenExpiry DateTime?
  
  // Password reset fields
  resetToken        String?
  resetTokenExpiry  DateTime?
  
  // Personal Information
  title             String   // Dr, Prof, etc.
  firstName         String
  middleName        String?
  lastName          String
  profilePicture    String?
  dateOfBirth       DateTime
  gender            String   // Male/Female/Other
  completeAddress   String   // House/Apt, Street
  city              String
  state             String
  zipcode           String
  alternativeEmail  String?
  primaryPhone      String
  alternativePhone  String?
  
  // Professional Information
  licenseNumber     String   @unique
  specialization   String   // e.g., "Cardiology", "General Practice"
  qualifications   String[] // Array of qualifications
  experience       Int      // Years of experience
  bio              String?  // Professional biography
  
  // Availability
  isAvailable      Boolean  @default(true)
  consultationFee  Decimal  @db.Decimal(10, 2)
  
  // Status
  isVerified       Boolean  @default(false)
  
  // Google Calendar Integration
  googleCalendarConnected    Boolean  @default(false)
  googleCalendarId          String?  // Doctor's specific calendar ID
  googleRefreshToken        String?  // Doctor's OAuth refresh token
  googleAccessToken         String?  // Doctor's OAuth access token
  googleTokenExpiry         DateTime? // When the access token expires
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  schedules        Schedule[]
  appointments     Appointment[]
  services        DoctorService[]
  bookings        Booking[]
  workingHours    WorkingHours[]

  @@map("doctors")
}

// Admin model for super administrators
model Admin {
  id                String   @id @default(uuid())
  
  // Authentication fields
  email             String   @unique
  password          String
  isActive          Boolean  @default(true)
  
  // Email verification fields
  isEmailVerified           Boolean  @default(false)
  emailVerificationToken    String?
  emailVerificationTokenExpiry DateTime?
  
  // Password reset fields
  resetToken        String?
  resetTokenExpiry  DateTime?
  
  // Personal Information
  firstName         String
  lastName          String
  profilePicture    String?
  phone             String?
  
  // Admin specific fields
  role              String   @default("superadmin") // superadmin, admin, etc.
  permissions       String[] // Array of permission strings
  lastLoginAt       DateTime?
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("admins")
}

// Service model for different types of medical services
// Global Service model - independent of doctors
model Service {
  id                String   @id @default(uuid())
  name              String   @unique // Service name must be unique globally
  description       String?
  category          String   // e.g., "Consultation", "Procedure", "Test"
  duration          Int      // Duration in minutes
  basePrice         Decimal  @db.Decimal(10, 2)
  isActive          Boolean  @default(true)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  appointments      Appointment[]
  bookings         Booking[]
  doctorServices   DoctorService[]
  
  @@map("services")
}

// Doctor-specific service customizations (optional)
model DoctorService {
  id                String   @id @default(uuid())
  doctorId          String
  serviceId         String
  customPrice       Decimal? @db.Decimal(10, 2) // Doctor can override base price
  customDuration    Int?     // Doctor can override duration
  isAvailable       Boolean  @default(true)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  doctor            Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  service           Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  @@unique([doctorId, serviceId]) // Each doctor can have one customization per service
  @@map("doctor_services")
}


// Working Hours model for doctor's weekly schedule
model WorkingHours {
  id                String   @id @default(uuid())
  doctorId          String
  dayOfWeek         Int      // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
  startTime         String   // Format: "HH:MM"
  endTime           String   // Format: "HH:MM"
  isActive          Boolean  @default(true)
  slotDuration      Int      @default(20) // Duration of each slot in minutes
  breakDuration     Int      @default(10) // Duration of break between slots in minutes
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  doctor            Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  generatedSchedules Schedule[]
  
  @@unique([doctorId, dayOfWeek])
  @@map("working_hours")
}

model Message {
  id        String   @id @default(uuid())
  content   String
  senderId  String   // Can be doctor ID or patient ID
  receiverId String  // Can be doctor ID or patient ID
  senderType String  // 'doctor' or 'patient'
  receiverType String // 'doctor' or 'patient'
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Note: No foreign key constraints since senderId/receiverId can reference either User or Doctor tables
  // Relations are handled in application logic based on senderType/receiverType

  @@map("messages")
}

// Schedule model for doctor availability (now auto-generated from working hours)
model Schedule {
  id                String   @id @default(uuid())
  doctorId          String
  workingHoursId    String?  // Reference to working hours that generated this schedule
  date              DateTime @db.Date
  startTime         String   // Format: "HH:MM"
  endTime           String   // Format: "HH:MM"
  isAvailable       Boolean  @default(true)
  maxAppointments   Int      @default(10) // Maximum appointments for this time slot
  isAutoGenerated   Boolean  @default(false) // Whether this was auto-generated from working hours
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  doctor            Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  workingHours      WorkingHours? @relation(fields: [workingHoursId], references: [id], onDelete: Cascade)
  slots             Slot[]
  
  @@unique([doctorId, date, startTime])
  @@map("schedules")
}

// Slot model for individual appointment slots
model Slot {
  id                String   @id @default(uuid())
  scheduleId        String
  startTime         String   // Format: "HH:MM"
  endTime           String   // Format: "HH:MM"
  isAvailable       Boolean  @default(true)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  schedule          Schedule     @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  appointment       Appointment[]
  
  @@unique([scheduleId, startTime])
  @@map("slots")
}

// Payment model for tracking Stripe payments
model Payment {
  id                String   @id @default(uuid())
  appointmentId     String   @unique
  stripePaymentId   String   @unique
  amount            Decimal  @db.Decimal(10, 2)
  currency          String   @default("usd")
  status            PaymentStatus
  paymentMethod     String?  // card, bank_transfer, etc.
  paymentIntent     String   @unique // Stripe payment intent ID - make it unique
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  paidAt            DateTime?
  
  // Relations
  appointment       Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  
  @@map("payments")
}

model PrimaryService {
  id                String   @id @default(uuid())
  name              String
  description       String?
  category          String   // e.g., "Consultation", "Procedure", "Test"
  duration          Int      // Duration in minutes
  basePrice         Decimal  @db.Decimal(10, 2)
  isActive          Boolean  @default(true)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  appointments      Appointment[]

  @@unique([name])
  @@map("primary_services")
}

// Appointment model for booked appointments
model Appointment {
  id                String   @id @default(uuid())
  patientId         String
  doctorId          String?  // Made optional - will be assigned by admin later
  serviceId         String
  primaryServiceId  String?
  slotId            String?  // Made optional - slots are tied to doctor schedules
  appointmentDate   DateTime @db.Date
  appointmentTime   String   // Format: "HH:MM"
  selectedSlotTime  String?  // Store the slot time user selected (for later doctor assignment)
  duration          Int      // Duration in minutes
  
  // Status tracking
  status            AppointmentStatus @default(PENDING)
  
  // Patient information
  patientNotes      String?
  symptoms          String?
  
  // Doctor internal notes
  internalNotes     String?  // Doctor's internal notes for this appointment
  
  // Prescribed medications grouped by medical service
  // Example shape: { "Hormone Optimization / TRT": ["Testosterone injections", "Enclomiphene"], "Hair Loss Treatments": ["Oral Minoxidil"] }
  medications       Json?
  
  // Payment and billing
  amount            Decimal  @db.Decimal(10, 2)
  isPaid            Boolean  @default(false)
  paymentMethod     String?
  
  // Video consultation
  googleMeetLink    String?  // Google Meet link for video consultation
  
  // Cancellation and rescheduling
  cancellationReason String?
  rescheduledFrom   String?  // Reference to previous appointment ID
  
  // Timestamps
  scheduledAt       DateTime @default(now())
  confirmedAt       DateTime?
  cancelledAt       DateTime?
  completedAt       DateTime?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  patient           User     @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor            Doctor?  @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  service           Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  slot              Slot?    @relation(fields: [slotId], references: [id], onDelete: Cascade)
  primaryService    PrimaryService? @relation(fields: [primaryServiceId], references: [id], onDelete: Cascade)
  payment           Payment?
  medicalForm       MedicalForm?
  
  @@map("appointments")
}

// Booking model for appointment requests
model Booking {
  id                String   @id @default(uuid())
  patientId         String
  doctorId          String
  serviceId         String
  preferredDate     DateTime @db.Date
  preferredTime     String   // Format: "HH:MM"
  alternativeDates  DateTime[] @db.Date // Alternative preferred dates
  alternativeTimes  String[] // Alternative preferred times
  
  // Patient information
  patientNotes      String?
  symptoms          String?
  urgency           UrgencyLevel @default(ROUTINE)
  
  // Status
  status            BookingStatus @default(PENDING)
  
  // Response
  doctorNotes       String?
  suggestedDate     DateTime?
  suggestedTime     String?
  
  // Timestamps
  requestedAt       DateTime @default(now())
  respondedAt       DateTime?
  expiresAt         DateTime? // When the booking request expires
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  patient           User     @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor            Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  service           Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  @@map("bookings")
}

// Enums
enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  CANCELLED
  REFUNDED
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
  RESCHEDULED
}

enum BookingStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
  CONVERTED_TO_APPOINTMENT
}

enum UrgencyLevel {
  ROUTINE
  URGENT
  EMERGENCY
}

// Medical Consultation Form Model - Based on 9-screen intake process
model MedicalForm {
  id        String   @id @default(uuid())
  patientId String
  appointmentId String? @unique // Optional for migration, will be required after cleanup
  
  // Screen 1 - Welcome (handled in UI)
  
  // Screen 2 - About You (only additional fields not in registration)
  // Note: fullName, dateOfBirth, gender, phone, email, address are already in User registration
  height String? // Physical measurements
  weight String?
  waist String?
  // Note: emergencyContactName and emergencyContactPhone are already in User registration
  
  // Screen 3 - Your Goals (check all that apply)
  goalMoreEnergy Boolean @default(false)
  goalBetterSexualPerformance Boolean @default(false)
  goalLoseWeight Boolean @default(false)
  goalHairRestoration Boolean @default(false)
  goalImproveMood Boolean @default(false)
  goalLongevity Boolean @default(false)
  goalOther Boolean @default(false)
  goalOtherDescription String?
  
  // Screen 4 - Medical Background
  chronicConditions String? // List of chronic conditions
  pastSurgeriesHospitalizations String? // Text box for past surgeries/hospitalizations
  currentMedications String? // Auto-complete field for current medications
  allergies String? // Text box for allergies
  
  // Screen 5 - Lifestyle & Habits
  sleepHoursPerNight String? // Hours/night
  sleepQuality String? // Poor/Fair/Good
  exerciseFrequency String? // None/1-2x/week/3-5x/week/Daily
  dietType String? // Balanced/High protein/Low-carb/Plant-based/Other
  alcoholUse String? // None/Social/Regular
  tobaccoUse String? // Never/Current/Former
  cannabisOtherSubstances String? // None/Yes
  cannabisOtherSubstancesList String? // List if Yes
  stressLevel String? // Low/Medium/High
  
  // Screen 6 - Symptom Check
  symptomFatigue Boolean @default(false)
  symptomLowLibido Boolean @default(false)
  symptomMuscleLoss Boolean @default(false)
  symptomWeightGain Boolean @default(false)
  symptomGynecomastia Boolean @default(false)
  symptomBrainFog Boolean @default(false)
  symptomMoodSwings Boolean @default(false)
  symptomPoorSleep Boolean @default(false)
  symptomHairThinning Boolean @default(false)
  
  // Screen 7 - Safety Check
  historyProstateBreastCancer Boolean @default(false)
  historyBloodClotsMIStroke Boolean @default(false)
  currentlyUsingHormonesPeptides Boolean @default(false)
  planningChildrenNext12Months Boolean @default(false)
  
  // Screen 8 - Labs & Uploads
  labUploads String? // File paths or references to uploaded labs
  labSchedulingNeeded Boolean @default(false)
  
  // Screen 9 - Consent & Finalize
  consentTelemedicineCare Boolean @default(false)
  consentElectiveOptimizationTreatment Boolean @default(false)
  consentRequiredLabMonitoring Boolean @default(false)
  digitalSignature String?
  consentDate DateTime?
  
  // Legacy fields for backward compatibility
  chiefComplaint String?
  historyOfPresentIllness String?
  pastMedicalHistory String?
  pastSurgicalHistory String?
  familyHistory String?
  workHistory String?
  medications String?
  
  // Review of Systems (ROS)
  generalSymptoms String?
  cardiovascularSymptoms String?
  respiratorySymptoms String?
  gastrointestinalSymptoms String?
  genitourinarySymptoms String?
  neurologicalSymptoms String?
  musculoskeletalSymptoms String?
  skinSymptoms String?
  psychiatricSymptoms String?
  endocrineSymptoms String?
  otherSymptoms String?
  
  // Physical Exam
  bloodPressure String?
  heartRate String?
  respiratoryRate String?
  temperature String?
  oxygenSaturation String?
  bmi String?
  
  // System-based Examination
  generalExam String?
  heentExam String?
  chestLungsExam String?
  heartExam String?
  abdomenExam String?
  neurologicalExam String?
  musculoskeletalExam String?
  
  // Clinical Process
  investigationsLabs String?
  assessmentDiagnosis String?
  planTreatment String?
  referrals String?
  additionalNotes String?
  
  // Care Coordination
  clinician String?
  pharmacy String?
  insurance String?
  primaryCareProvider String?
  referringPhysicians String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  patient User @relation(fields: [patientId], references: [id], onDelete: Cascade)
  appointment Appointment? @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  
  @@map("medical_forms")
}

